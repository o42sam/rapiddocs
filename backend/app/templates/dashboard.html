<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - RapidDocs Backend</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .username {
            font-size: 14px;
        }

        .logout-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-menu {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .nav-item {
            padding: 15px 20px;
            color: #555;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .nav-item.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        }

        .stat-label {
            color: #888;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            color: #333;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-change {
            font-size: 13px;
            color: #666;
        }

        .stat-change.positive {
            color: #27ae60;
        }

        .stat-change.negative {
            color: #e74c3c;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            text-align: left;
            padding: 12px;
            color: #666;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
        }

        .table td {
            padding: 12px;
            color: #333;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .btn-primary {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            padding: 6px 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #e74c3c;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .health-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .health-status.operational {
            background: #d4edda;
            color: #155724;
        }

        .health-status.degraded {
            background: #fff3cd;
            color: #856404;
        }

        .health-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }

        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>RapidDocs Admin Dashboard</h1>
            </div>
            <div class="user-info">
                <span class="username" id="username">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <nav class="nav-menu">
        <div class="nav-content">
            <a class="nav-item active" onclick="showTab('dashboard')" id="tab-dashboard">Dashboard</a>
            <a class="nav-item" onclick="showTab('health')" id="tab-health">Health Status</a>
            <a class="nav-item" onclick="showTab('referrals')" id="tab-referrals">Referral Keys</a>
            <a class="nav-item" onclick="openDocs()">API Docs â†—</a>
        </div>
    </nav>

    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">Loading dashboard data...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="tab-content active" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-change" id="userChange">Loading...</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Active Today</div>
                    <div class="stat-value" id="dailyActive">0</div>
                    <div class="stat-change positive">Daily active users</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Documents Generated</div>
                    <div class="stat-value" id="totalDocs">0</div>
                    <div class="stat-change" id="docsToday">0 today</div>
                </div>

                <div class="stat-card">
                    <div class="stat-label">Server Uptime</div>
                    <div class="stat-value" id="uptime">0d 0h</div>
                    <div class="stat-change">Since last deployment</div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">System Information</h2>
                <table class="table">
                    <tr>
                        <td><strong>Total Admins:</strong></td>
                        <td id="totalAdmins">0</td>
                    </tr>
                    <tr>
                        <td><strong>Active Admins:</strong></td>
                        <td id="activeAdmins">0</td>
                    </tr>
                    <tr>
                        <td><strong>Weekly Active Users:</strong></td>
                        <td id="weeklyActive">0</td>
                    </tr>
                    <tr>
                        <td><strong>Monthly Active Users:</strong></td>
                        <td id="monthlyActive">0</td>
                    </tr>
                    <tr>
                        <td><strong>Documents This Week:</strong></td>
                        <td id="docsWeek">0</td>
                    </tr>
                    <tr>
                        <td><strong>Documents This Month:</strong></td>
                        <td id="docsMonth">0</td>
                    </tr>
                    <tr>
                        <td><strong>Last Deployment:</strong></td>
                        <td id="lastDeployment">Unknown</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Health Tab -->
        <div id="health-content" class="tab-content">
            <div class="section">
                <h2 class="section-title">Health Check Status</h2>
                <div id="healthBasic">
                    <p>Loading health status...</p>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Detailed Health Information</h2>
                <div id="healthDetailed">
                    <p>Loading detailed health information...</p>
                </div>
            </div>
        </div>

        <!-- Referral Keys Tab -->
        <div id="referrals-content" class="tab-content">
            <div class="section">
                <h2 class="section-title">Referral Keys Management</h2>
                <button class="btn-primary" onclick="createReferralKey()" style="margin-bottom: 20px;">Create New Key</button>
                <table class="table" id="referralTable">
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Created By</th>
                            <th>Uses</th>
                            <th>Status</th>
                            <th>Expires</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="referralTableBody">
                        <!-- Keys will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUser = null;

        // Check authentication on load
        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            await loadUserInfo();
            await loadDashboard();
        });

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected tab
            const tabContent = document.getElementById(`${tabName}-content`);
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
            }

            // Set active nav item
            const navItem = document.getElementById(`tab-${tabName}`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Load tab-specific content
            if (tabName === 'health') {
                loadHealthData();
            } else if (tabName === 'referrals') {
                loadReferralKeys();
            }
        }

        async function openDocs() {
            const token = localStorage.getItem('access_token');
            // Open docs in new window with auth token in header
            // Since we can't set headers for window.open, we'll use the token in the URL
            window.open(`${API_URL}/docs`, '_blank');
        }

        async function loadUserInfo() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_URL}/admin/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('username').textContent = `${currentUser.full_name} (${currentUser.username})`;
                } else if (response.status === 401) {
                    // Token expired, try to refresh
                    await refreshToken();
                } else {
                    throw new Error('Failed to load user info');
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                window.location.href = '/login';
            }
        }

        async function loadDashboard() {
            const token = localStorage.getItem('access_token');
            const loadingDiv = document.getElementById('loading');
            const dashboardDiv = document.getElementById('dashboard-content');
            const errorDiv = document.getElementById('error');

            try {
                const response = await fetch(`${API_URL}/admin/dashboard/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load dashboard stats');
                }

                const stats = await response.json();

                // Update stats
                document.getElementById('totalUsers').textContent = stats.total_users;
                document.getElementById('dailyActive').textContent = stats.daily_active_users;
                document.getElementById('totalDocs').textContent = stats.total_documents_generated;
                document.getElementById('docsToday').textContent = `${stats.documents_today} today`;
                document.getElementById('uptime').textContent = stats.server_uptime;
                document.getElementById('totalAdmins').textContent = stats.total_admins;
                document.getElementById('activeAdmins').textContent = stats.active_admins;
                document.getElementById('weeklyActive').textContent = stats.weekly_active_users;
                document.getElementById('monthlyActive').textContent = stats.monthly_active_users;
                document.getElementById('docsWeek').textContent = stats.documents_this_week;
                document.getElementById('docsMonth').textContent = stats.documents_this_month;
                document.getElementById('lastDeployment').textContent = new Date(stats.last_deployment).toLocaleString();

                // Hide loading, show dashboard
                loadingDiv.style.display = 'none';
                dashboardDiv.style.display = 'block';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                loadingDiv.style.display = 'none';
                errorDiv.textContent = 'Failed to load dashboard data. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        async function loadHealthData() {
            const token = localStorage.getItem('access_token');
            const basicDiv = document.getElementById('healthBasic');
            const detailedDiv = document.getElementById('healthDetailed');

            // Load basic health
            try {
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    const data = await response.json();
                    basicDiv.innerHTML = `
                        <p><strong>Status:</strong> <span class="health-status operational">HEALTHY</span></p>
                        <p><strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                    `;
                } else {
                    basicDiv.innerHTML = '<p class="error">Failed to load basic health status</p>';
                }
            } catch (error) {
                basicDiv.innerHTML = '<p class="error">Error loading health status</p>';
            }

            // Load detailed health
            try {
                const response = await fetch(`${API_URL}/health/detailed`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    let servicesHtml = '<table class="table"><thead><tr><th>Service</th><th>Status</th></tr></thead><tbody>';

                    for (const [service, status] of Object.entries(data.services)) {
                        const statusClass = status === 'operational' ? 'operational' :
                                          status === 'degraded' ? 'degraded' : 'error';
                        servicesHtml += `
                            <tr>
                                <td>${service}</td>
                                <td><span class="health-status ${statusClass}">${status.toUpperCase()}</span></td>
                            </tr>
                        `;
                    }

                    servicesHtml += '</tbody></table>';

                    detailedDiv.innerHTML = `
                        <p><strong>Overall Status:</strong> <span class="health-status ${data.status === 'healthy' ? 'operational' : 'degraded'}">${data.status.toUpperCase()}</span></p>
                        <p><strong>Environment:</strong> ${data.environment}</p>
                        <p><strong>Version:</strong> ${data.version}</p>
                        <h3 style="margin-top: 20px; margin-bottom: 10px;">Services</h3>
                        ${servicesHtml}
                        <h3 style="margin-top: 20px; margin-bottom: 10px;">Full Response</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    detailedDiv.innerHTML = '<p class="error">Failed to load detailed health status. Authentication may be required.</p>';
                }
            } catch (error) {
                detailedDiv.innerHTML = '<p class="error">Error loading detailed health status</p>';
            }
        }

        async function loadReferralKeys() {
            const token = localStorage.getItem('access_token');
            const tbody = document.getElementById('referralTableBody');

            try {
                const response = await fetch(`${API_URL}/admin/referral-keys`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load referral keys');
                }

                const keys = await response.json();

                // Clear existing rows
                tbody.innerHTML = '';

                // Add keys to table
                keys.forEach(key => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td><code style="font-size: 11px;">${key.key.substring(0, 20)}...</code></td>
                        <td>${key.created_by}</td>
                        <td>${key.current_uses} / ${key.max_uses}</td>
                        <td>${key.is_active ? '<span style="color: #27ae60;">Active</span>' : '<span style="color: #e74c3c;">Inactive</span>'}</td>
                        <td>${key.expires_at ? new Date(key.expires_at).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <button class="btn-danger" onclick="deleteReferralKey('${key.key}')">Delete</button>
                        </td>
                    `;
                });

                if (keys.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No referral keys found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading referral keys:', error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #e74c3c;">Failed to load referral keys</td></tr>';
            }
        }

        async function createReferralKey() {
            const token = localStorage.getItem('access_token');
            const maxUses = prompt('Maximum uses for this key (1-10):', '1');
            const expiresInDays = prompt('Expires in days (leave empty for no expiration):', '');
            const notes = prompt('Notes (optional):', '');

            if (!maxUses) return;

            const data = {
                max_uses: parseInt(maxUses),
                notes: notes || null
            };

            if (expiresInDays) {
                data.expires_in_days = parseInt(expiresInDays);
            }

            try {
                const response = await fetch(`${API_URL}/admin/referral-key`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const key = await response.json();
                    // Show success message
                    const successDiv = document.getElementById('success');
                    successDiv.innerHTML = `<strong>New referral key created:</strong><br><code>${key.key}</code><br>Please save this key securely.`;
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 10000);

                    await loadReferralKeys();
                } else {
                    const error = await response.json();
                    alert(`Failed to create key: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error creating referral key:', error);
                alert('Failed to create referral key');
            }
        }

        async function deleteReferralKey(key) {
            if (!confirm('Are you sure you want to delete this referral key? This action cannot be undone.')) {
                return;
            }

            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_URL}/admin/referral-key/${encodeURIComponent(key)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const successDiv = document.getElementById('success');
                    successDiv.textContent = 'Referral key deleted successfully.';
                    successDiv.style.display = 'block';
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 5000);

                    await loadReferralKeys();
                } else {
                    const error = await response.json();
                    alert(`Failed to delete key: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error deleting referral key:', error);
                alert('Failed to delete referral key');
            }
        }

        async function refreshToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            if (!refreshToken) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/admin/refresh`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${refreshToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('refresh_token', data.refresh_token);
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
                window.location.href = '/login';
            }
        }

        async function logout() {
            const token = localStorage.getItem('access_token');

            try {
                await fetch(`${API_URL}/admin/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }

            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            window.location.href = '/login';
        }
    </script>
</body>
</html>